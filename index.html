<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <title>A S√∂t√©t M√°gia √ötveszt≈ëje</title>

  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-control" content="no-cache">
  <meta http-equiv="Cache" content="no-cache">

  <meta name="description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta name="keywords" content="kalandk√∂nyv, interakt√≠v k√∂nyv, fantasy, s√∂t√©t m√°gia">
  <link rel="icon" href="files/icon-512.png" type="image/png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="A S√∂t√©t M√°gia √ötveszt≈ëje">
  <meta property="og:description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta property="og:image" content="./files/icon-512.png">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000000; font-family: 'Cinzel', serif; }
    #book-container { width: 100%; height: 100vh; overflow: hidden; position: relative; background-color: #000000; }
    #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
    #loading-screen img { /* stilus */ }
    #install-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #368B27; color: white; text-align: center; padding: 0.75rem; font-family: 'Roboto', sans-serif; font-weight: 600; font-size: 1rem; line-height: 1.4; z-index: 10000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; text-transform: uppercase; box-sizing: border-box; }
    #install-banner small { display: block; margin-top: 0.25rem; font-weight: 400; font-size: 0.85em; opacity: 0.8; text-transform: none; }
    @media (max-width: 768px) { #install-banner { font-size: 1.125rem; padding: 1rem; } }
    @media (min-width: 1200px) { #install-banner { font-size: 0.9rem; } }
    .controls-container { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 999; display: flex; justify-content: center; align-items: center; gap: 15px; background-color: rgba(0, 0, 0, 0.3); padding: 8px 0; box-sizing: border-box; }
    .control-button { background-color: rgba(50, 50, 50, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); color: #e0e0e0; padding: 8px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; transition: background-color 0.3s, border-color 0.3s; }
    .control-button:hover { background-color: rgba(80, 80, 80, 0.8); border-color: rgba(255, 255, 255, 0.5); }
    .control-button svg { width: 20px; height: 20px; stroke: currentColor; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script src="js/firebase-config.js"></script>
  <script src="js/auth-token-service.js"></script>
  <script src="js/auth-service.js"></script>
  <script src="js/activation-ui.js"></script>

  <script src="js/pages-data.js"></script>

  <script src="js/content-loader.js"></script>

</head>
<body>

  <div id="install-banner">
    üì≤ Telep√≠tsd az alkalmaz√°st a f≈ëk√©perny≈ëre!<br>
    <small>
      1. Kattints a b√∂ng√©sz≈ë men√ºj√©re (√°ltal√°ban ‚ãÆ vagy ...)<br> 2. V√°laszd: "Telep√≠t√©s" vagy "Hozz√°ad√°s a F≈ëk√©perny≈ëh√∂z"
    </small>
  </div>

  <div id="loading-screen">
    <img src="images/homokora_loader.gif" alt="Bet√∂lt√©s..." width="60" height="60">
  </div>

  <div id="book-container">
    </div>

  <audio id="flip-sound" src="sounds/pageturn-102978.mp3" preload="auto"></audio>

  <script src="flipbook-engine.js"></script>

  <script>
    let flipbookInstance = null; // Glob√°lis referencia a flipbook motorhoz

    // --- Oldal bet√∂lt√©se a hash alapj√°n ---
    function loadPageFromHash() {
      // V√°rjuk meg, am√≠g minden bet√∂lt≈ëdik √©s inicializ√°l√≥dik
      if (!window.contentLoader || !window.contentLoader.isInitialized || !flipbookInstance) {
          console.log("loadPageFromHash: V√°rakoz√°s a ContentLoader vagy FlipbookEngine inicializ√°l√°s√°ra...");
          // Itt nem h√≠vjuk √∫jra, a DOMContentLoaded gondoskodik az els≈ë h√≠v√°sr√≥l,
          // a hashchange listener pedig a k√©s≈ëbbi esem√©nyekr≈ël.
          // Esetleg egy √∫jrapr√≥b√°lkoz√°s lehetne, de bonyol√≠tan√°.
          return;
      }

      let pageId = location.hash.substring(1); // # jel elt√°vol√≠t√°sa
      console.log(`Hash v√°ltozott vagy oldal bet√∂lt≈ëd√∂tt, hash: '${location.hash}', pageId: '${pageId}'`);

      // Alap√©rtelmezett oldal, ha nincs hash, vagy nem sz√°m (kiv√©ve 'borito')
      // Aktiv√°lt √°llapotban az 1. oldalra, egy√©bk√©nt a bor√≠t√≥ra.
      // Ezt az ellen≈ërz√©st ak√°r az activationUI is jelezhetn√© egy glob√°lis v√°ltoz√≥val.
      if (!pageId || (isNaN(parseInt(pageId, 10)) && pageId !== 'borito')) {
         // Itt ellen≈ërizhetn√©nk, hogy aktiv√°lva van-e a user, pl. token alapj√°n
         const hasToken = window.authTokenService && window.authTokenService.getAccessToken();
         pageId = hasToken ? '1' : 'borito'; // Ha van token -> 1. oldal, ha nincs -> bor√≠t√≥
         console.log(`Nincs √©rv√©nyes hash, alap√©rtelmezett oldal bet√∂lt√©se: ${pageId}`);
         // Opcion√°lis: Friss√≠ts√ºk a hash-t is, hogy az URL t√ºkr√∂zze az √°llapotot
         // history.replaceState(null, '', `#${pageId}`); // Ez nem v√°lt ki hashchange esem√©nyt
      }

       // Tartalom bet√∂lt√©se a ContentLoaderrel
       console.log(`Tartalom bet√∂lt√©se a ${pageId} azonos√≠t√≥hoz...`);
       window.contentLoader.loadContent(pageId).catch(err => {
           console.error(`Hiba a contentLoader.loadContent h√≠v√°sakor (${pageId}):`, err);
           // Itt is megjelen√≠thet√ºnk egy √°ltal√°nos hiba√ºzenetet, ha a loader nem tette meg
           if (flipbookInstance && typeof flipbookInstance._renderPage === 'function') { // Felt√©telezve, hogy van ilyen bels≈ë f√ºggv√©ny
                flipbookInstance._renderPage(pageId, `<h1>Hiba</h1><p>Az oldal bet√∂lt√©se sikertelen (${pageId}).</p>`);
           }
       });
    }

    // --- Glob√°lis funkci√≥ a lapoz√°shoz (iframe-ekb≈ël vagy JS-b≈ël h√≠vhat√≥) ---
    function goToPage(pageNumber) {
         const pageId = String(pageNumber); // Stringg√© alak√≠t√°s
         console.log(`Glob√°lis goToPage h√≠vva: ${pageId}. Hash be√°ll√≠t√°sa...`);
         // Egyszer≈±en be√°ll√≠tjuk a hash-t. A 'hashchange' esem√©nykezel≈ë fogja int√©zni a bet√∂lt√©st.
         location.hash = `#${pageId}`;
     }

    // --- Ind√≠t√°s a DOM bet√∂lt≈ëd√©se ut√°n ---
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('loading-screen');
      try {
        // V√°rakoz√°s a sz√ºks√©ges szolg√°ltat√°sokra (Auth, Token, ContentLoader, PageData)
        // A ContentLoader constructor-a m√°r v√°r ezekre, itt el√©g r√° v√°rni.
         let checkCount = 0;
         while (!window.contentLoader?.isInitialized && checkCount < 50) { // Max ~15 mp v√°rakoz√°s
             console.log("DOMContentLoaded: V√°rakoz√°s a ContentLoader inicializ√°l√°s√°ra...");
             await new Promise(resolve => setTimeout(resolve, 300));
             checkCount++;
         }

         if (!window.contentLoader?.isInitialized) {
             console.error("DOMContentLoaded: ContentLoader inicializ√°l√°sa id≈ët√∫ll√©p√©s!");
             throw new Error("Alkalmaz√°s komponensek nem t√∂lt≈ëdtek be id≈ëben.");
         }
         console.log("DOMContentLoaded: ContentLoader inicializ√°lva.");

        // Aktiv√°ci√≥ ellen≈ërz√©se - Ez d√∂nti el, hogy az aktiv√°l√≥ UI kell-e
        console.log("DOMContentLoaded: ActivationUI inicializ√°l√°sa...");
        const isActivated = await window.activationUI.initialize();
        console.log(`DOMContentLoaded: ActivationUI initialize Befejez≈ëd√∂tt, eredm√©ny (isActivated): ${isActivated}`);

        // Flipbook Engine inicializ√°l√°sa MINDIG (m√©g ha csak a hibaoldalt mutatja is)
        // A tartalom bet√∂lt√©s√©t majd a hash alapj√°n int√©zz√ºk
        if (typeof FlipbookEngine !== 'undefined') {
              console.log("DOMContentLoaded: FlipbookEngine inicializ√°l√°sa...");
              flipbookInstance = new FlipbookEngine({
                containerId: 'book-container',
                // TotalPages itt tal√°n nem is kell, ha a navig√°ci√≥ m√°shogy m≈±k√∂dik
                // totalPages: 300, // Vagy a bookPageData hossza: Object.keys(window.bookPageData || {}).length
                soundPath: 'sounds/pageturn-102978.mp3'
                // FONTOS: A FlipbookEngine-nek sz√ºks√©ge van a renderCallback-re a ContentLoader-t≈ël!
              });
              // Be√°ll√≠tjuk a renderel√©si callback-et a ContentLoaderben
              if (window.contentLoader && typeof flipbookInstance.renderPage === 'function') {
                  window.contentLoader.setup(flipbookInstance.renderPage.bind(flipbookInstance));
                  console.log("DOMContentLoaded: ContentLoader renderCallback be√°ll√≠tva a FlipbookEngine-re.");
              } else {
                   console.error("Hiba: Nem siker√ºlt be√°ll√≠tani a renderCallback-et! Ellen≈ërizd a FlipbookEngine 'renderPage' met√≥dus√°t.");
              }
              console.log("DOMContentLoaded: FlipbookEngine sikeresen inicializ√°lva.");
        } else {
               console.error("Hiba: FlipbookEngine oszt√°ly nem tal√°lhat√≥!");
        }

        // --- Kezd≈ëoldal bet√∂lt√©se a hash alapj√°n (vagy alap√©rtelmezett) ---
        loadPageFromHash();

        // Bet√∂lt≈ë k√©perny≈ë elrejt√©se
        if (loadingScreen) {
            setTimeout(() => {
              loadingScreen.style.opacity = '0';
              setTimeout(() => {
                if(loadingScreen) loadingScreen.style.display = 'none';
              }, 500);
            }, 500); // Kicsit gyorsabban, mint kor√°bban
        }

      } catch (error) {
        console.error('Kritikus hiba az alkalmaz√°s inicializ√°l√°sa sor√°n:', error);
        if (loadingScreen) {
            loadingScreen.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Hiba t√∂rt√©nt az alkalmaz√°s ind√≠t√°sakor. (${error.message})</p>`;
             loadingScreen.style.opacity = '1';
        }
      }
    });

    // --- Hash v√°ltoz√°s figyel√©se a navig√°ci√≥hoz ---
    window.addEventListener('hashchange', loadPageFromHash);

  </script>
  <script>
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); console.log('[InstallPrompt] beforeinstallprompt esem√©ny √©rz√©kelve.');
      const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (isInStandaloneMode) { console.log('[InstallPrompt] Az app telep√≠tett (standalone) m√≥dban fut, banner nem jelenik meg.'); const ib = document.getElementById('install-banner'); if(ib) ib.style.display = 'none'; return; }
      if (sessionStorage.getItem('installBannerShown')) { console.log('[InstallPrompt] A banner m√°r megjelent ebben a munkamenetben.'); return; }
      console.log('[InstallPrompt] Telep√≠t√©si prompt elt√°rolva.'); deferredPrompt = e;
      const installBanner = document.getElementById('install-banner');
      if (installBanner) { console.log('[InstallPrompt] Telep√≠t√©si banner megjelen√≠t√©se.'); installBanner.style.display = 'block'; sessionStorage.setItem('installBannerShown', 'true'); }
      else { console.error('[InstallPrompt] Az "install-banner" elem nem tal√°lhat√≥!'); }
    });
    const bannerElement = document.getElementById('install-banner');
    if (bannerElement) {
      bannerElement.addEventListener('click', async () => {
        console.log('[InstallPrompt] Bannerre kattint√°s √©rz√©kelve.'); bannerElement.style.display = 'none';
        if (!deferredPrompt) { console.log('[InstallPrompt] Nincs elt√°rolt prompt esem√©ny.'); return; }
        try {
          console.log('[InstallPrompt] Telep√≠t√©si prompt megjelen√≠t√©se...'); deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice; console.log(`[InstallPrompt] Felhaszn√°l√≥ v√°lasza a promptra: ${outcome}`);
          deferredPrompt = null;
        } catch (error) { console.error('[InstallPrompt] Hiba a telep√≠t√©si prompt megjelen√≠t√©se k√∂zben:', error); deferredPrompt = null; }
      });
    } else { console.error('[InstallPrompt] Nem siker√ºlt click esem√©nykezel≈ët hozz√°adni: Az "install-banner" elem nem tal√°lhat√≥!'); }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('./service-worker.js')
            .then(() => console.log('Service Worker sikeresen regisztr√°lva'))
            .catch(err => console.error('Service Worker regisztr√°ci√≥s hiba:', err));
      });
    }
  </script>

</body>
</html>