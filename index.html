<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <title>A S√∂t√©t M√°gia √ötveszt≈ëje</title>

  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-control" content="no-cache">
  <meta http-equiv="Cache" content="no-cache">

  <meta name="description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta name="keywords" content="kalandk√∂nyv, interakt√≠v k√∂nyv, fantasy, s√∂t√©t m√°gia">
  <link rel="icon" href="files/icon-512.png" type="image/png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="A S√∂t√©t M√°gia √ötveszt≈ëje">
  <meta property="og:description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta property="og:image" content="./files/icon-512.png">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet"> <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000000; /* H√°tt√©r fekete */
      font-family: 'Cinzel', serif; /* Alap√©rtelmezett bet≈±t√≠pus */
    }

    #book-container {
      width: 100%;
      height: 100vh; /* Teljes n√©zetablak magass√°g */
      overflow: hidden;
      position: relative;
      background-color: #000000; /* Kont√©ner h√°ttere is fekete */
    }

    /* Bet√∂lt≈ë k√©perny≈ë */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000; /* Fekete h√°tt√©r */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    /* Loader k√©p st√≠lusa (ha k√©pet haszn√°lsz) */
    #loading-screen img {
       /* Itt adhatsz meg extra st√≠lusokat a k√©pnek, ha kell */
       /* Pl. max-width: 80px; */
    }

    /* Telep√≠t√©si banner */
    #install-banner {
      display: none; /* Alapb√≥l rejtett */
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      background: #368B27; /* Z√∂ld h√°tt√©r */
      color: white;
      text-align: center;
      padding: 0.75rem;
      font-family: 'Roboto', sans-serif; /* Roboto bet≈±t√≠pus a bannerhez */
      font-weight: 600;
      font-size: 1rem;
      line-height: 1.4;
      z-index: 10000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
      text-transform: uppercase;
      box-sizing: border-box; /* Padding belesz√°m√≠t a sz√©less√©gbe */
    }

    /* Az als√≥ instrukci√≥ kisebb√≠thet≈ë */
    #install-banner small {
      display: block;
      margin-top: 0.25rem;
      font-weight: 400;
      font-size: 0.85em;
      opacity: 0.8;
      text-transform: none; /* Nem kell nagybet≈±snek lennie */
    }

    /* M√©dia lek√©rdez√©sek a reszponzivit√°shoz (maradtak) */
    @media (max-width: 768px) {
      #install-banner {
        font-size: 1.125rem;
        padding: 1rem;
      }
    }
    @media (min-width: 1200px) {
      #install-banner {
        font-size: 0.9rem;
      }
    }

    /* St√≠lusok a Flipbook vez√©rl≈ë gombjaihoz (√°thelyezve flipbook-engine.ts-b≈ël ide a jobb √°tl√°that√≥s√°g√©rt) */
    .controls-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 999; /* Alacsonyabb, mint a bet√∂lt≈ë/aktiv√°ci√≥s k√©perny≈ë */
        display: flex;
        justify-content: center; /* Gombok k√∂z√©pre */
        align-items: center;
        gap: 15px; /* T√©rk√∂z a gombok k√∂z√∂tt */
        background-color: rgba(0, 0, 0, 0.3); /* Enyh√©n √°tl√°tsz√≥ h√°tt√©r */
        padding: 8px 0;
        box-sizing: border-box;
    }

    .control-button {
        background-color: rgba(50, 50, 50, 0.7); /* S√∂t√©tsz√ºrke gomb h√°tt√©r */
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e0e0e0; /* Vil√°gossz√ºrke ikon */
        padding: 8px;
        border-radius: 50%; /* Kerek gombok */
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px; /* Fix m√©ret */
        height: 40px; /* Fix m√©ret */
        transition: background-color 0.3s, border-color 0.3s;
    }

    .control-button:hover {
        background-color: rgba(80, 80, 80, 0.8);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .control-button svg {
        width: 20px; /* SVG ikon m√©rete */
        height: 20px;
        stroke: currentColor; /* Az ikon sz√≠ne a gomb sz√≠n√©t veszi fel */
    }

  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script src="js/firebase-config.js"></script> <script src="js/auth-token-service.js"></script> <script src="js/auth-service.js"></script> <script src="js/activation-ui.js"></script> <script src="js/content-loader.js"></script> </head>
<body>

  <div id="install-banner">
    <big>üì≤ Telep√≠tsd az alkalmaz√°st a f≈ëk√©perny≈ëre!<br>
    
      1. Kattints erre a fel√ºletre!<br> 2. V√°laszd: "Telep√≠t√©s" vagy "Hozz√°ad√°s a F≈ëk√©perny≈ëh√∂z"
    </big>
  </div>

  <div id="loading-screen">
    <img src="images/homokora_loader.gif" alt="Bet√∂lt√©s..." width="60" height="60"> </div>

  <div id="book-container">
    </div>

  <audio id="flip-sound" src="sounds/pageturn-102978.mp3" preload="auto"></audio>

  <script src="flipbook-engine.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('loading-screen');
      try {
        // Megv√°rjuk, am√≠g az √∂sszes sz√ºks√©ges szolg√°ltat√°s inicializ√°l√≥dik
        // (Egyszer≈± v√°rakoz√°s, lehetne kifinomultabb is)
        while (!window.firebaseApp || !window.authService || !window.activationUI || !window.contentLoader || !window.authTokenService) {
             console.log("V√°rakoz√°s a szolg√°ltat√°sok inicializ√°l√°s√°ra...");
             await new Promise(resolve => setTimeout(resolve, 100));
        }
        console.log("Minden szolg√°ltat√°s inicializ√°lva.");


        // Aktiv√°ci√≥ ellen≈ërz√©se (ez h√≠vja az authService.checkStoredAuth-t)
        console.log("ActivationUI inicializ√°l√°sa...");
        const isActivated = await window.activationUI.initialize();
        console.log(`ActivationUI initialize Befejez≈ëd√∂tt, eredm√©ny (isActivated): ${isActivated}`);

        // Ha aktiv√°lva van (van user √âS √©rv√©nyes token), akkor ind√≠tjuk a k√∂nyvet
        if (isActivated) {
          console.log("Aktiv√°lt √°llapot, FlipbookEngine inicializ√°l√°sa...");
          // FlipbookEngine inicializ√°l√°sa
          // Figyelem: Biztos√≠tsd, hogy a FlipbookEngine oszt√°ly defin√≠ci√≥ja
          // a flipbook-engine.js-ben van √©s be van t√∂ltve e script el≈ëtt!
          if (typeof FlipbookEngine !== 'undefined') {
              const flipbook = new FlipbookEngine({
                containerId: 'book-container',
                totalPages: 300, // Ezt √°ll√≠tsd be a t√©nyleges oldalsz√°mra
                soundPath: 'sounds/pageturn-102978.mp3'
              });
              console.log("FlipbookEngine sikeresen inicializ√°lva.");
               // Glob√°lis hivatkoz√°s l√©trehoz√°sa, ha sz√ºks√©ges a lapoz√°shoz linkekb≈ël
               window.flipbookInstance = flipbook;
          } else {
               console.error("Hiba: FlipbookEngine oszt√°ly nem tal√°lhat√≥!");
               // Itt lehetne egy hiba√ºzenetet megjelen√≠teni a felhaszn√°l√≥nak
          }

          // Bet√∂lt≈ë k√©perny≈ë elrejt√©se k√©sleltet√©ssel
          if (loadingScreen) {
            setTimeout(() => {
              loadingScreen.style.opacity = '0';
              setTimeout(() => {
                if(loadingScreen) loadingScreen.style.display = 'none';
              }, 500); // fade-out id≈ë
            }, 800); // Kis v√°rakoz√°s a tartalom bet√∂lt≈ëd√©se ut√°n
          }

        } else {
          // Ha nincs aktiv√°lva (nincs user vagy nincs token),
          // akkor az activationUI m√°r l√©trehozta a fel√ºletet az initialize() sor√°n.
          // Csak a bet√∂lt≈ë k√©perny≈ët kell elrejteni, hogy l√°that√≥v√° v√°ljon.
          console.log("Nem aktiv√°lt √°llapot, bet√∂lt≈ë k√©perny≈ë elrejt√©se az aktiv√°ci√≥s UI megjelen√≠t√©s√©hez.");
          if (loadingScreen) {
            // Nincs sz√ºks√©g k√©sleltet√©sre, azonnal elrejtj√ºk
            loadingScreen.style.opacity = '0';
             setTimeout(() => {
                if(loadingScreen) loadingScreen.style.display = 'none';
             }, 500); // fade-out id≈ë
          }
        }
      } catch (error) {
        // √Åltal√°nos inicializ√°l√°si hiba kezel√©se
        console.error('Kritikus hiba az alkalmaz√°s inicializ√°l√°sa sor√°n:', error);
        if (loadingScreen) {
            loadingScreen.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Hiba t√∂rt√©nt az alkalmaz√°s ind√≠t√°sakor. K√©rlek, pr√≥b√°ld meg k√©s≈ëbb.</p>`;
             loadingScreen.style.opacity = '1'; // Jelen√≠ts√ºk meg a hiba√ºzenetet
        }
        // Esetleg itt megpr√≥b√°lhatn√°nk t√∂r√∂lni a t√°rolt adatokat, hogy tiszta lappal induljon legk√∂zelebb
        // localStorage.clear(); sessionStorage.clear();
      }
    });

     // Glob√°lis funkci√≥ a lapoz√°shoz (iframe-ekb≈ël h√≠vhat√≥)
     function goToPage(pageNumber) {
         console.log(`Glob√°lis goToPage h√≠vva: ${pageNumber}`);
         if (window.flipbookInstance) {
             // Figyelem: a flipbookInstance.loadPage most m√°r a jogosults√°g-ellen≈ërz√∂tt
             // contentLoader-t haszn√°lja a h√°tt√©rben.
             window.flipbookInstance.loadPage(pageNumber);
         } else {
             console.error("Flipbook instance nem el√©rhet≈ë a lapoz√°shoz!");
         }
     }

     // Glob√°lis funkci√≥ a kocka widget megjelen√≠t√©s√©hez/elrejt√©s√©hez
     // (Ha a kocka JS a f≈ë oldalon van, √©s nem az iframe-ben)
     /*
     function toggleDiceWidget() {
         const widget = document.getElementById('dice-widget-container');
         if (widget) {
             widget.style.display = widget.style.display === 'none' ? 'block' : 'none';
             // Itt lehetne a kockadob√≥ logika inicializ√°l√°sa is
         }
     }
     */
     // Megjegyz√©s: Ha a kocka widgetek HTML/JS k√≥dja az adott oldalak (iframe-ek)
     // r√©sz√©t k√©pezi, akkor ez a glob√°lis funkci√≥ nem sz√ºks√©ges itt.

  </script>

  <script>
    let deferredPrompt; // Glob√°lis v√°ltoz√≥ a prompt esem√©ny t√°rol√°s√°ra

    window.addEventListener('beforeinstallprompt', (e) => {
      // 1. Akad√°lyozzuk meg az alap√©rtelmezett mini-infobar megjelen√©s√©t
      e.preventDefault();
      console.log('[InstallPrompt] beforeinstallprompt esem√©ny √©rz√©kelve.');

      // 2. Ellen≈ërizz√ºk, hogy az app telep√≠tett m√≥dban fut-e m√°r
      const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (isInStandaloneMode) {
        console.log('[InstallPrompt] Az app telep√≠tett (standalone) m√≥dban fut, banner nem jelenik meg.');
        // Ha telep√≠tve fut, elrejtj√ºk a bannert, ha esetleg l√°that√≥ lenne
         const installBanner = document.getElementById('install-banner');
         if (installBanner) {
             installBanner.style.display = 'none';
         }
        return; // Kil√©p√ºnk, nem kell bannert mutatni
      }

      // 3. Ellen≈ërizz√ºk, hogy ebben a munkamenetben m√°r megmutattuk-e a bannert
      if (sessionStorage.getItem('installBannerShown')) {
        console.log('[InstallPrompt] A banner m√°r megjelent ebben a munkamenetben, nem jelen√≠tj√ºk meg √∫jra.');
        return; // Kil√©p√ºnk, nem mutatjuk meg √∫jra
      }

      // 4. Ha nem telep√≠tett m√≥dban fut √©s m√©g nem mutattuk meg -> Elt√°roljuk az esem√©nyt k√©s≈ëbbre
      console.log('[InstallPrompt] Telep√≠t√©si prompt elt√°rolva.');
      deferredPrompt = e;

      // 5. Megjelen√≠tj√ºk a saj√°t banner√ºnket
      const installBanner = document.getElementById('install-banner');
      if (installBanner) {
        console.log('[InstallPrompt] Telep√≠t√©si banner megjelen√≠t√©se.');
        installBanner.style.display = 'block';
        // Be√°ll√≠tunk egy jelz≈ët a sessionStorage-ben, hogy tudjuk, m√°r megmutattuk
        sessionStorage.setItem('installBannerShown', 'true');
      } else {
         console.error('[InstallPrompt] Az "install-banner" elem nem tal√°lhat√≥!');
      }
    });

    // Bannerre kattint√°s kezel√©se
    const bannerElement = document.getElementById('install-banner');
    if (bannerElement) {
      bannerElement.addEventListener('click', async () => {
        console.log('[InstallPrompt] Bannerre kattint√°s √©rz√©kelve.');
        // Elrejtj√ºk a bannert azonnal
        bannerElement.style.display = 'none';

        // Ellen≈ërizz√ºk, hogy van-e elt√°rolt prompt esem√©ny√ºnk
        if (!deferredPrompt) {
          console.log('[InstallPrompt] Nincs elt√°rolt prompt esem√©ny.');
          return; // Ha nincs, nem tudunk mit tenni
        }

        // Megjelen√≠tj√ºk a b√∂ng√©sz≈ë telep√≠t√©si p√°rbesz√©dablak√°t
        try {
          console.log('[InstallPrompt] Telep√≠t√©si prompt megjelen√≠t√©se...');
          deferredPrompt.prompt();
          // V√°rjuk meg a felhaszn√°l√≥ v√°lasz√°t
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`[InstallPrompt] Felhaszn√°l√≥ v√°lasza a promptra: ${outcome}`);
          // Ak√°r 'accepted' (elfogadta), ak√°r 'dismissed' (elvetette),
          // a promptot felhaszn√°ltuk, t√∂r√∂lj√ºk a referenci√°t.
          deferredPrompt = null;
        } catch (error) {
           console.error('[InstallPrompt] Hiba a telep√≠t√©si prompt megjelen√≠t√©se k√∂zben:', error);
           deferredPrompt = null; // Hiba eset√©n is t√∂r√∂lj√ºk
        }
      });
    } else {
         console.error('[InstallPrompt] Nem siker√ºlt click esem√©nykezel≈ët hozz√°adni: Az "install-banner" elem nem tal√°lhat√≥!');
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      // K√©sleltetj√ºk kicsit a regisztr√°ci√≥t, hogy a f≈ëbb JS f√°jlok bet√∂lt≈ëdjenek el≈ëbb
      window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('./service-worker.js')
            .then(() => console.log('Service Worker sikeresen regisztr√°lva'))
            .catch(err => console.error('Service Worker regisztr√°ci√≥s hiba:', err));
      });
    }
  </script>

</body>
</html>
