<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <title>A S√∂t√©t M√°gia √ötveszt≈ëje</title>
  
  <!-- PWA be√°ll√≠t√°sok -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-control" content="no-cache">
  <meta http-equiv="Cache" content="no-cache">
  
  <!-- SEO √©s k√∂z√∂ss√©gi m√©dia be√°ll√≠t√°sok -->
  <meta name="description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta name="keywords" content="kalandk√∂nyv, interakt√≠v k√∂nyv, fantasy, s√∂t√©t m√°gia">
  <link rel="icon" href="files/icon-512.png" type="image/png">
  <link rel="apple-touch-icon" href="files/icon-192.png">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="A S√∂t√©t M√°gia √ötveszt≈ëje">
  <meta property="og:description" content="Dark fantasy kalandk√∂nyv, ahol a f≈ëh≈ës te vagy!">
  <meta property="og:image" content="./files/icon-512.png">
  
  <!-- Google Font - El≈ëre bet√∂ltve a kritikus fontokat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
 
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #121212; /* S√∂t√©tebb alap h√°tt√©r */
      font-family: 'Cinzel', serif;
      -webkit-tap-highlight-color: transparent; /* Mobil tap highlight elt√°vol√≠t√°sa */
    }
    
    #book-container {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    /* Bet√∂lt≈ë k√©perny≈ë */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    
    #loading-message {
      color: #7f00ff;
      font-family: 'Cinzel', serif;
      text-align: center;
      margin-top: 20px;
      font-size: 18px;
    }
    
    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #7f00ff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Telep√≠t√©si banner */
    #install-banner {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      background: #368B27;
      color: white;
      text-align: center;
      padding: 0.75rem;
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      line-height: 1.4;
      z-index: 10000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
      text-transform: uppercase;
    }

    /* Az als√≥ instrukci√≥ kisebb√≠thet≈ë */
    #install-banner small {
      display: block;
      margin-top: 0.25rem;
      font-weight: 400;
      font-size: 0.85em;
      opacity: 0.8;
      text-transform: uppercase;
    }

    /* Tablet, nagyobb mobil: kicsit nagyobb bet≈± */
    @media (max-width: 768px) {
      #install-banner {
        font-size: 1.125rem;
        padding: 1rem;
      }
      
      #loading-message {
        width: 80%;
        font-size: 16px;
      }
    }

    /* Nagy monitorokon kicsit kisebb: ne foglaljon t√∫l sok helyet */
    @media (min-width: 1200px) {
      #install-banner {
        font-size: 0.9rem;
      }
    }
	
    /* Hiba√ºzenet kont√©ner a f≈ë hiba√°llapothoz */
    #error-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 10001;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #fff;
      font-family: 'Cinzel', serif;
    }
    
    #error-container h2 {
      color: #ff5555;
      margin-bottom: 1rem;
    }
    
    #error-container p {
      margin: 0.5rem 0;
      max-width: 80%;
    }
    
    #error-container button {
      background-color: #7f00ff;
      color: #fff;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Cinzel', serif;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <!-- Hiba√°llapot kont√©ner -->
  <div id="error-container" style="display:none;">
    <h2>Hiba t√∂rt√©nt</h2>
    <p>Az alkalmaz√°s bet√∂lt√©se k√∂zben probl√©ma l√©pett fel.</p>
    <p>K√©rj√ºk, ellen≈ërizd az internetkapcsolatot √©s pr√≥b√°ld √∫jra.</p>
    <button id="error-retry-btn" onclick="window.location.reload()">√öjrapr√≥b√°lkoz√°s</button>
  </div>

  <!-- Telep√≠t√©s banner -->
  <div id="install-banner">
    üì≤ Telep√≠tsd az alkalmaz√°st a f≈ëk√©perny≈ëre!<br>
    <small style="font-size:0.9em; opacity:0.8;">
      1. Kattints ide<br>
      2. V√°laszd: "Hozz√°ad√°s a F≈ëk√©perny≈ëh√∂z" lehet≈ës√©get!
    </small>
  </div>

  <!-- Bet√∂lt≈ë k√©perny≈ë -->
  <div id="loading-screen">
    <div class="loader"></div>
    <div id="loading-message">Bet√∂lt√©s...</div>
  </div>

  <!-- K√∂nyv kont√©ner -->
  <div id="book-container">
    <!-- A FlipbookEngine ide fogja beilleszteni az iframe-eket -->
  </div>
  
  <!-- Hangok - csak akkor t√∂lt≈ëdnek be, ha val√≥ban sz√ºks√©gesek -->
  <audio id="flip-sound" preload="none" src="sounds/pageturn-102978.mp3"></audio>

  <!-- Firebase SDK - inline k√∂zvetlen√ºl -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Firebase konfigur√°ci√≥ - inline -->
  <script>
    // Firebase konfigur√°ci√≥
    const firebaseConfig = {
      apiKey: "AIzaSyDxsN0vk0dAoDu7GYn2Bl8WoKDejy6q1vA",
      authDomain: "a-s-m-u.firebaseapp.com",
      projectId: "a-s-m-u",
      storageBucket: "a-s-m-u.firebasestorage.app",
      messagingSenderId: "317821756996",
      appId: "1:317821756996:web:61d1b94b291080592abe11",
      measurementId: "G-ENT3XNTKTE"
    };

    // Bet√∂lt√©si √°llapot √©s hibak√∂vet√©s
    const loadingStates = {
      start: "Bet√∂lt√©s...",
      firebase: "Firebase inicializ√°l√°sa...",
      auth: "Hiteles√≠t√©s ellen≈ërz√©se...",
      activation: "Aktiv√°ci√≥ ellen≈ërz√©se...",
      book: "K√∂nyv bet√∂lt√©se...",
      complete: "K√©sz!"
    };
    
    function updateLoadingMessage(state) {
      const loadingMessage = document.getElementById('loading-message');
      if (loadingMessage) {
        loadingMessage.textContent = loadingStates[state] || state;
      }
    }
    
    function showErrorScreen(message) {
      const errorContainer = document.getElementById('error-container');
      const errorParagraphs = errorContainer.querySelectorAll('p');
      
      if (errorParagraphs.length > 0 && message) {
        errorParagraphs[0].textContent = message;
      }
      
      document.getElementById('loading-screen').style.display = 'none';
      errorContainer.style.display = 'flex';
    }
    
    // Alapvet≈ë hiba elkap√°sa
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Glob√°lis hiba:', message, error);
      showErrorScreen('V√°ratlan hiba t√∂rt√©nt: ' + message);
      return true; // Megakad√°lyozza a b√∂ng√©sz≈ë alap√©rtelmezett hibajelz√©s√©t
    };
    
    try {
      updateLoadingMessage('firebase');
      
      // Firebase inicializ√°l√°sa
      firebase.initializeApp(firebaseConfig);

      // Firebase szolg√°ltat√°sok
      window.firebaseApp = {
        auth: firebase.auth(),
        db: firebase.firestore()
      };
      
      console.log("Firebase sikeresen inicializ√°lva");
    } catch (error) {
      console.error("Firebase inicializ√°l√°si hiba:", error);
      showErrorScreen("Nem siker√ºlt inicializ√°lni a Firebase-t: " + error.message);
    }
  </script>

  <!-- AuthService √©s ActivationUI l√©trehoz√°sa -->
  <script>
    // AuthService - A kalandk√∂nyv autentik√°ci√≥s szolg√°ltat√°sa
    class AuthService {
      constructor() {
        // Ellen≈ërizz√ºk, hogy a Firebase sikeresen inicializ√°l√≥dott-e
        if (!window.firebaseApp || !window.firebaseApp.auth || !window.firebaseApp.db) {
          console.error('Firebase nem inicializ√°l√≥dott megfelel≈ëen');
          // Alap√©rtelmezett √©rt√©kek, hogy ne kapjunk hib√°t k√©s≈ëbb
          this.auth = null; 
          this.db = null;
        } else {
          this.auth = window.firebaseApp.auth;
          this.db = window.firebaseApp.db;
        }
        
        this.STORAGE_KEY = 'kalandkonyv_auth';
        this.CODES_COLLECTION = 'activationCodes';
        
        // Autentik√°ci√≥ v√°ltoz√°s√°nak figyel√©se (csak ha sikeresen inicializ√°l√≥dott)
        if (this.auth) {
          this.auth.onAuthStateChanged(user => {
            if (user) {
              console.log('Felhaszn√°l√≥ bejelentkezve:', user.uid);
            } else {
              console.log('Nincs bejelentkezett felhaszn√°l√≥');
            }
          });
        }
      }
      
      // Helyi t√°rol√°s el√©rhet≈ës√©g√©nek ellen≈ërz√©se
      _isStorageAvailable() {
        try {
          const testKey = '__storage_test__';
          localStorage.setItem(testKey, testKey);
          localStorage.removeItem(testKey);
          return true;
        } catch (e) {
          console.warn('localStorage nem √©rhet≈ë el:', e);
          return false;
        }
      }
      
      // Adatok biztons√°gos ment√©se localStorage-ba
      _saveToStorage(key, data) {
        if (!this._isStorageAvailable()) return false;
        
        try {
          localStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (error) {
          console.error('Hiba a localStorage √≠r√°sa k√∂zben:', error);
          return false;
        }
      }
      
      // Adatok biztons√°gos olvas√°sa localStorage-b√≥l
      _loadFromStorage(key) {
        if (!this._isStorageAvailable()) return null;
        
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (error) {
          console.error('Hiba a localStorage olvas√°sa k√∂zben:', error);
          return null;
        }
      }
      
      // Adat t√∂rl√©se a localStorage-b√≥l
      _removeFromStorage(key) {
        if (!this._isStorageAvailable()) return;
        
        try {
          localStorage.removeItem(key);
        } catch (error) {
          console.error('Hiba a localStorage t√∂rl√©se k√∂zben:', error);
        }
      }
      
      // Ellen≈ërzi, van-e t√°rolt autentik√°ci√≥
      async checkStoredAuth() {
        try {
          // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°l√≥dott-e
          if (!this.auth || !this.db) {
            console.error('Firebase szolg√°ltat√°sok nem √©rhet≈ëk el');
            return null;
          }
          
          // Adatok bet√∂lt√©se a localStorage-b√≥l
          const storedAuth = this._loadFromStorage(this.STORAGE_KEY);
          if (!storedAuth) {
            console.log('Nincs t√°rolt autentik√°ci√≥');
            return null;
          }
          
          console.log('T√°rolt autentik√°ci√≥ bet√∂ltve:', storedAuth.userId);
          
          // Ellen≈ërizz√ºk, hogy a t√°rolt token √©rv√©nyes-e m√©g
          if (this.auth.currentUser) {
            console.log('M√°r van bejelentkezett felhaszn√°l√≥:', this.auth.currentUser.uid);
            if (this.auth.currentUser.uid === storedAuth.userId) {
              console.log('A bejelentkezett felhaszn√°l√≥ egyezik a t√°rolttal');
              return this.auth.currentUser;
            }
            console.log('A bejelentkezett felhaszn√°l√≥ k√ºl√∂nb√∂zik a t√°rolt√≥l, kijelentkez√©s...');
            await this.auth.signOut(); // Kil√©ptetj√ºk, mert nem egyezik
          }
          
          // Pr√≥b√°ljunk meg √∫jra bejelentkezni
          console.log('Megpr√≥b√°lunk bejelentkezni a t√°rolt adatokkal...');
          try {
            await this.auth.signInAnonymously();
            console.log('N√©vtelen bejelentkez√©s sikeres:', this.auth.currentUser?.uid);
            
            // Ellen≈ërizz√ºk, hogy a kapott UID egyezik-e a t√°roltal
            if (this.auth.currentUser && this.auth.currentUser.uid === storedAuth.userId) {
              console.log('Az √∫j bejelentkez√©s sikeresen vissza√°ll√≠totta az eszk√∂zt');
              return this.auth.currentUser;
            } else {
              console.log('Az √∫j bejelentkez√©s nem egyezik a t√°rolt adatokkal, t√∂rl√©s...');
              this._removeFromStorage(this.STORAGE_KEY);
              return null;
            }
          } catch (error) {
            console.error('Hiba t√∂rt√©nt a bejelentkez√©s sor√°n:', error);
            this._removeFromStorage(this.STORAGE_KEY);
            return null;
          }
        } catch (error) {
          console.error('Hiba a t√°rolt autentik√°ci√≥ ellen≈ërz√©sekor:', error);
          return null;
        }
      }
      
      // Aktiv√°ci√≥s k√≥d ellen≈ërz√©se
      async verifyActivationCode(code) {
        try {
          // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°l√≥dott-e
          if (!this.auth || !this.db) {
            console.error('Firebase szolg√°ltat√°sok nem √©rhet≈ëk el');
            return { valid: false, message: 'Hiba: Firebase szolg√°ltat√°sok nem √©rhet≈ëk el' };
          }
          
          console.log('K√≥d ellen≈ërz√©se:', code);
          const codeDoc = await this.db.collection(this.CODES_COLLECTION).doc(code).get();
          
          if (!codeDoc.exists) {
            console.log('A k√≥d nem l√©tezik:', code);
            return { valid: false, message: '√ârv√©nytelen aktiv√°ci√≥s k√≥d' };
          }
          
          const codeData = codeDoc.data();
          const currentUser = this.auth.currentUser;
          
          console.log('K√≥d adatok:', JSON.stringify(codeData));
          console.log('Jelenlegi felhaszn√°l√≥:', currentUser?.uid);
          
          // 1. Ellen≈ërz√©s: A k√≥d √°llapota
          if (codeData.status === 'unused') {
            // Ez egy √∫j, m√©g nem haszn√°lt k√≥d - azonnal √©rv√©nyes√≠thet≈ë
            console.log('√öj, nem haszn√°lt k√≥d');
            return { valid: true };
          } 
          else if (codeData.status === 'active') {
            // Ez egy m√°r akt√≠v k√≥d, ellen≈ërizz√ºk az eszk√∂z√∂ket
            console.log('M√°r akt√≠v k√≥d, eszk√∂z√∂k ellen≈ërz√©se');
            
            // 1.a Ellen≈ërz√©s: Van-e devices t√∂mb
            const devices = codeData.devices || [];
            
            // 1.b Ellen≈ërz√©s: Ez az eszk√∂z m√°r szerepel-e a list√°ban?
            const deviceExists = devices.some(device => device.deviceId === currentUser?.uid);
            if (deviceExists) {
              // Ez az eszk√∂z m√°r hiteles√≠tve van, enged√©lyezz√ºk az √∫jb√≥li haszn√°latot
              console.log('Ez az eszk√∂z m√°r aktiv√°lva van ezen a k√≥don');
              return { valid: true, alreadyActivated: true };
            }
            
            // 1.c Ellen≈ërz√©s: Van-e m√©g hely √∫j eszk√∂z sz√°m√°ra?
            const maxDevices = codeData.maxDevices || 3; // Alap√©rtelmezetten 3
            if (devices.length >= maxDevices) {
              console.log('A k√≥d el√©rte a maximum eszk√∂zsz√°mot:', devices.length, '>=', maxDevices);
              return { 
                valid: false, 
                message: `Ez a k√≥d m√°r el√©rte a maximum haszn√°lhat√≥ eszk√∂z√∂k sz√°m√°t (${maxDevices})` 
              };
            }
            
            // Ha ide√°ig eljutottunk, a k√≥d egy √∫j eszk√∂z√∂n aktiv√°lhat√≥
            console.log('A k√≥d aktiv√°lhat√≥ √∫j eszk√∂z√∂n');
            return { valid: true };
          } 
          else {
            // B√°rmilyen m√°s √°llapot (pl. "expired", ha k√©s≈ëbb bevezetj√ºk)
            console.log('A k√≥d nem haszn√°lhat√≥ √°llapotban van:', codeData.status);
            return { valid: false, message: 'Ez a k√≥d m√°r nem haszn√°lhat√≥' };
          }
        } catch (error) {
          console.error('Hiba a k√≥d ellen≈ërz√©sekor:', error);
          return { valid: false, message: 'Hiba t√∂rt√©nt a k√≥d ellen≈ërz√©sekor: ' + error.message };
        }
      }

      // N√©vtelen bejelentkez√©s
      async signInAnonymously() {
        try {
          // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°l√≥dott-e
          if (!this.auth) {
            console.error('Firebase Auth nem √©rhet≈ë el');
            throw new Error('Firebase Auth nem √©rhet≈ë el');
          }
          
          console.log('N√©vtelen bejelentkez√©s k√≠s√©rlet...');
          const result = await this.auth.signInAnonymously();
          console.log('N√©vtelen bejelentkez√©s sikeres:', result.user?.uid);
          return result;
        } catch (error) {
          console.error('N√©vtelen bejelentkez√©si hiba:', error);
          throw error;
        }
      }
      
      // A k√≥dot megjel√∂li akt√≠vk√©nt √©s hozz√°adja az eszk√∂zt - JAV√çTOTT!
      async markCodeAsActive(code, userId) {
        try {
          // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°l√≥dott-e
          if (!this.db) {
            console.error('Firebase Firestore nem √©rhet≈ë el');
            throw new Error('Firebase Firestore nem √©rhet≈ë el');
          }
          
          console.log('K√≥d aktiv√°l√°sa:', code, 'eszk√∂z:', userId);
          const codeRef = this.db.collection(this.CODES_COLLECTION).doc(code);
          const codeDoc = await codeRef.get();
          
          if (!codeDoc.exists) {
            console.error('A k√≥d nem l√©tezik:', code);
            throw new Error('A k√≥d nem l√©tezik');
          }
          
          const codeData = codeDoc.data();
          const currentDevices = codeData.devices || [];
          
          console.log('Jelenlegi eszk√∂z√∂k:', JSON.stringify(currentDevices));
          
          const deviceExists = currentDevices.some(device => device.deviceId === userId);
          
          // Ha az eszk√∂z m√°r szerepel a list√°ban, nincs sz√ºks√©g friss√≠t√©sre
          if (deviceExists) {
            console.log('Ez az eszk√∂z m√°r szerepel a list√°ban, nincs sz√ºks√©g friss√≠t√©sre');
            return true;
          }
          
          // FONTOS JAV√çT√ÅS: Ne haszn√°ljuk a FieldValue-t, mert mobilokon hib√°t okoz
          // Ehelyett egyszer≈± √∫j d√°tum objektumot haszn√°lunk
          const timestamp = new Date();
          
          // √öj eszk√∂z hozz√°ad√°sa
          const updatedDevices = [
            ...currentDevices,
            {
              deviceId: userId,
              activatedAt: timestamp  // Kliens oldali id≈ëb√©lyeg a FieldValue helyett
            }
          ];
          
          console.log('Friss√≠tett eszk√∂zlista:', JSON.stringify(updatedDevices));
          
          // K√≥d st√°tusz√°nak √©s eszk√∂zlist√°j√°nak friss√≠t√©se
          await codeRef.update({
            status: 'active',  // "unused" ‚Üí "active"
            devices: updatedDevices
          });
          
          console.log('K√≥d sikeresen aktiv√°lva, eszk√∂z hozz√°adva');
          return true;
        } catch (error) {
          console.error('Hiba a k√≥d aktiv√°l√°sakor:', error);
          throw error;
        }
      }
      
      // Hiteles√≠t√©si adatok ment√©se
      async storeCredentials(user) {
        try {
          // Ellen≈ërizz√ºk, hogy a param√©ter √©rv√©nyes-e
          if (!user || !user.uid) {
            console.error('√ârv√©nytelen felhaszn√°l√≥:', user);
            throw new Error('√ârv√©nytelen felhaszn√°l√≥');
          }
          
          console.log('Hiteles√≠t√©si adatok ment√©se:', user.uid);
          
          try {
            const token = await user.getIdToken();
            
            const authData = {
              userId: user.uid,
              token: token,
              createdAt: Date.now()
            };
            
            // Biztons√°gos ment√©s a localStorage-ba
            const success = this._saveToStorage(this.STORAGE_KEY, authData);
            
            if (success) {
              console.log('Hiteles√≠t√©si adatok sikeresen mentve');
            } else {
              console.warn('Nem siker√ºlt menteni a hiteles√≠t√©si adatokat, de folytatjuk');
            }
            
            return authData;
          } catch (tokenError) {
            console.error('Hiba a token lek√©r√©sekor:', tokenError);
            
            // Ha a token lek√©r√©s hib√°val j√°r, ments√ºk legal√°bb a userId-t
            const fallbackData = {
              userId: user.uid,
              createdAt: Date.now()
            };
            
            this._saveToStorage(this.STORAGE_KEY, fallbackData);
            console.log('Egyszer≈±s√≠tett hiteles√≠t√©si adatok mentve');
            
            return fallbackData;
          }
        } catch (error) {
          console.error('Hiba a hiteles√≠t√©si adatok ment√©sekor:', error);
          throw error;
        }
      }
      
      // Kijelentkez√©s
      async signOut() {
        try {
          // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°l√≥dott-e
          if (!this.auth) {
            console.error('Firebase Auth nem √©rhet≈ë el');
            return false;
          }
          
          console.log('Kijelentkez√©s...');
          await this.auth.signOut();
          this._removeFromStorage(this.STORAGE_KEY);
          console.log('Kijelentkez√©s √©s adatt√∂rl√©s sikeres');
          return true;
        } catch (error) {
          console.error('Hiba a kijelentkez√©s sor√°n:', error);
          return false;
        }
      }
    }

    // Aktiv√°ci√≥s UI kezel≈ë
    class ActivationUI {
      constructor() {
        // Fontos: Biztos√≠tsd, hogy a window.authService l√©tezzen, miel≈ëtt ez lefut
        if (!window.authService) {
           console.error("AuthService m√©g nem inicializ√°l√≥dott, amikor az ActivationUI l√©trej√∂tt!");
        }
        this.authService = window.authService;
        this.isActivated = false;
        this.activationContainer = null;
      }

      // Aktiv√°ci√≥s UI inicializ√°l√°sa
      async initialize() {
        // Ellen≈ërizz√ºk, hogy az authService el√©rhet≈ë-e
        if (!this.authService) {
            console.error("AuthService nem el√©rhet≈ë az initialize h√≠v√°sakor.");
            return false; // Jelezz√ºk, hogy nem siker√ºlt az inicializ√°l√°s
        }

        // Ellen≈ërizz√ºk, hogy m√°r hiteles√≠tve van-e
        const user = await this.authService.checkStoredAuth();

        if (user) {
          console.log('Felhaszn√°l√≥ m√°r aktiv√°lva van:', user.uid);
          this.isActivated = true;
          this.remove(); // Ha m√°r aktiv√°lva van, t√°vol√≠tsuk el a UI-t, ha esetleg l√°that√≥ maradt
          return true;
        }

        // Aktiv√°ci√≥s UI l√©trehoz√°sa √©s megjelen√≠t√©se, ha m√©g nincs aktiv√°lva
        this._createActivationUI();
        return false;
      }

      // Aktiv√°ci√≥s UI l√©trehoz√°sa
      _createActivationUI() {
        // Ha m√°r l√©tezik, ne hozzunk l√©tre √∫jat
        if (this.activationContainer || document.getElementById('activation-container')) return;

        // Kont√©ner l√©trehoz√°sa
        this.activationContainer = document.createElement('div');
        this.activationContainer.id = 'activation-container';
        // Biztos√≠tjuk, hogy az authService l√©tezzen, miel≈ëtt az esem√©nykezel≈ëket hozz√°adjuk
        if (!this.authService) {
           console.error("AuthService nem el√©rhet≈ë a UI l√©trehoz√°sakor.");
           // Megjelen√≠thetsz egy hiba√ºzenetet a UI-ban
           this.activationContainer.innerHTML = `<div class="activation-overlay"><div class="activation-card"><p class="activation-message">Hiba: Authentik√°ci√≥s szolg√°ltat√°s nem √©rhet≈ë el.</p></div></div>`;
           document.body.appendChild(this.activationContainer);
           return; // Ne folytassuk az UI fel√©p√≠t√©s√©t
        }

        this.activationContainer.innerHTML = `
          <div class="activation-overlay">
            <div class="activation-card">
              <h2>A S√∂t√©t M√°gia √ötveszt≈ëje</h2>
              <p>K√∂sz√∂nj√ºk a v√°s√°rl√°st! A folytat√°shoz add meg az aktiv√°ci√≥s k√≥dodat:</p>
              <div class="activation-form">
                <input type="text" id="activation-code" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
                <button id="activate-btn">Aktiv√°l√°s</button>
              </div>
              <p id="activation-message" class="activation-message"></p>
              <p class="activation-info">Egy aktiv√°ci√≥s k√≥ddal a k√∂nyv ak√°r <strong>3 k√ºl√∂nb√∂z≈ë</strong> eszk√∂z√∂n is haszn√°lhat√≥.</p>
            </div>
          </div>
        `;

        // St√≠lusok hozz√°ad√°sa (ha m√©g nincsenek az oldalon)
        if (!document.getElementById('activation-styles')) {
            const style = document.createElement('style');
            style.id = 'activation-styles'; // ID hozz√°ad√°sa a duplik√°ci√≥ elker√ºl√©s√©re
            style.textContent = `
              .activation-overlay {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
              }

              .activation-card {
                background-color: #1a1a1a;
                color: #fff;
                border-radius: 8px;
                padding: 2rem;
                box-shadow: 0 0 30px rgba(127, 0, 255, 0.5);
                max-width: 90%;
                width: 400px;
                text-align: center;
                font-family: 'Cinzel', serif;
              }

              .activation-card h2 {
                color: #7f00ff;
                margin-bottom: 1.5rem;
              }

              .activation-form {
                margin: 1.5rem 0;
              }

              #activation-code {
                width: 100%;
                padding: 0.75rem;
                background-color: #333;
                border: 1px solid #7f00ff;
                border-radius: 4px;
                color: #fff;
                font-size: 1rem;
                margin-bottom: 1rem;
                text-align: center;
                letter-spacing: 2px;
                box-sizing: border-box; /* Hozz√°adva a padding miatti m√©retprobl√©m√°k elker√ºl√©s√©re */
              }

              #activate-btn {
                background-color: #7f00ff;
                color: #fff;
                border: none;
                padding: 0.75rem 2rem;
                font-size: 1rem;
                border-radius: 4px;
                cursor: pointer;
                font-family: 'Cinzel', serif;
                transition: background-color 0.3s;
              }

              #activate-btn:hover {
                background-color: #9b30ff;
              }

              #activate-btn:disabled {
                background-color: #5a00b3; /* Kicsit s√∂t√©tebb letiltva */
                cursor: not-allowed;
              }


              .activation-message {
                min-height: 1.5rem;
                margin-top: 1rem; /* Hozz√°adva egy kis t√©rk√∂z */
                font-weight: bold; /* Kiemel√©s */
              }

              .activation-message.error { /* K√ºl√∂n oszt√°ly a hib√°hoz */
                 color: #ff5555;
              }

              .activation-message.success {
                color: #55ff55;
              }
              
              .activation-info {
                font-size: 0.9rem;
                margin-top: 1.5rem;
                color: #ccc;
              }
              
              .activation-info strong {
                color: #9b30ff;
              }
              
              /* Mobil optimaliz√°ci√≥ */
              @media (max-width: 480px) {
                .activation-card {
                  padding: 1.5rem;
                  width: 90%;
                }
                
                #activation-code {
                  font-size: 1rem;
                  padding: 0.5rem;
                  letter-spacing: 1px;
                }
              }
            `;
            document.head.appendChild(style);
        }

        // Hozz√°adjuk az oldalhoz
        document.body.appendChild(this.activationContainer);

        // Esem√©nykezel≈ëk hozz√°ad√°sa
        // Biztos√≠tjuk, hogy az elemek l√©tezzenek, miel≈ëtt esem√©nykezel≈ët adunk hozz√°juk
        const activateButton = document.getElementById('activate-btn');
        const codeInput = document.getElementById('activation-code');

        if (activateButton) {
            activateButton.addEventListener('click', () => this._handleActivation());
        } else {
            console.error("Aktiv√°ci√≥s gomb (activate-btn) nem tal√°lhat√≥!");
        }

        if (codeInput) {
            codeInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') this._handleActivation();
            });
            
            // Mobilon gyakran probl√©ma a nagybet≈±s input, seg√≠ts√ºnk ezen
            codeInput.addEventListener('input', (e) => {
              let value = e.target.value;
              
              // Elt√°vol√≠tjuk a nem alfanumerikus karaktereket √©s nagybet≈±s√≠tj√ºk
              value = value.replace(/[^A-Za-z0-9-]/g, '').toUpperCase();
              
              // K√≥dform√°z√°s
              if (value.length > 4 && value.charAt(4) !== '-') {
                value = value.slice(0, 4) + '-' + value.slice(4);
              }
              if (value.length > 9 && value.charAt(9) !== '-') {
                value = value.slice(0, 9) + '-' + value.slice(9);
              }
              
              // Be√°ll√≠tjuk a form√°zott √©rt√©ket
              if (e.target.value !== value) {
                e.target.value = value;
              }
            });
        } else {
            console.error("Aktiv√°ci√≥s k√≥d beviteli mez≈ë (activation-code) nem tal√°lhat√≥!");
        }
      }

      // Aktiv√°ci√≥s √ºzenet megjelen√≠t√©se
       _showMessage(message, type = 'info') { // type lehet 'info', 'success', 'error'
        const messageElement = document.getElementById('activation-message');
        if (!messageElement) {
            console.error("√úzenet elem (activation-message) nem tal√°lhat√≥!");
            return;
        }

        messageElement.textContent = message;
        // Oszt√°lyok be√°ll√≠t√°sa a t√≠pus alapj√°n
        messageElement.className = 'activation-message'; // Alap oszt√°ly
        if (type === 'success') {
            messageElement.classList.add('success');
        } else if (type === 'error') {
            messageElement.classList.add('error');
        }
      }

      // Aktiv√°ci√≥s k√≥dkezel√©s - M√ìDOS√çTOTT VERZI√ì (Hibakezel√©ssel)
      async _handleActivation() {
        const codeInput = document.getElementById('activation-code');
        // Biztos√≠tjuk, hogy az authService l√©tezzen
        if (!this.authService) {
            console.error("AuthService nem el√©rhet≈ë a _handleActivation h√≠v√°sakor.");
            this._showMessage('Hiba: Authentik√°ci√≥s szolg√°ltat√°s nem el√©rhet≈ë.', 'error');
            return;
        }

        // Ellen≈ërizz√ºk, hogy a codeInput l√©tezik-e
        if (!codeInput) {
            console.error("Aktiv√°ci√≥s k√≥d beviteli mez≈ë nem tal√°lhat√≥ a _handleActivationben.");
            this._showMessage('Hiba: Nem tal√°lhat√≥ a k√≥d beviteli mez≈ë.', 'error');
            return;
        }
        const code = codeInput.value.trim().toUpperCase();


        if (!code) {
          this._showMessage('K√©rlek add meg az aktiv√°ci√≥s k√≥dot', 'error');
          return;
        }

        // Gomb letilt√°sa az ellen≈ërz√©s idej√©re
        const activateBtn = document.getElementById('activate-btn');
         if (!activateBtn) {
            console.error("Aktiv√°ci√≥s gomb nem tal√°lhat√≥ a _handleActivationben.");
            // A folyamat mehet tov√°bb, de a gombot nem tudjuk kezelni
        } else {
            activateBtn.disabled = true;
            activateBtn.textContent = 'Ellen≈ërz√©s...';
        }
        this._showMessage(''); // Kor√°bbi √ºzenet t√∂rl√©se

        try {
          // === Bejelentkez√©s biztos√≠t√°sa ===
          let currentUser = this.authService.auth.currentUser;
          // Ha nincs bejelentkezett felhaszn√°l√≥, pr√≥b√°ljunk meg bejelentkezni
          if (!currentUser) {
            console.log('Nincs akt√≠v felhaszn√°l√≥, n√©vtelen bejelentkez√©s megk√≠s√©rl√©se...');
            try {
              await this.authService.signInAnonymously();
              currentUser = this.authService.auth.currentUser; // Friss√≠tj√ºk a currentUser v√°ltoz√≥t
              if (!currentUser) {
                // Ha a bejelentkez√©s ut√°n sincs felhaszn√°l√≥, az komoly hiba
                throw new Error('N√©vtelen bejelentkez√©s sikertelen.');
              }
              console.log('N√©vtelen bejelentkez√©s sikeres:', currentUser.uid);
            } catch (signInError) {
              console.error('N√©vtelen bejelentkez√©si hiba:', signInError);
              this._showMessage('Hiba t√∂rt√©nt a bejelentkez√©s sor√°n.', 'error');
              if(activateBtn) { // Csak akkor √°ll√≠tjuk vissza, ha l√©tezik
                 activateBtn.disabled = false;
                 activateBtn.textContent = 'Aktiv√°l√°s';
              }
              return; // Megszak√≠tjuk a folyamatot, ha a bejelentkez√©s nem siker√ºl
            }
          } else {
             console.log('Akt√≠v felhaszn√°l√≥ m√°r van:', currentUser.uid);
          }
          // === Bejelentkez√©s biztos√≠t√°sa V√âGE ===

          // Most m√°r van bejelentkezett felhaszn√°l√≥ (currentUser), j√∂het a k√≥d ellen≈ërz√©se
          this._showMessage('K√≥d ellen≈ërz√©se...', 'info'); // T√°j√©koztat√≥ √ºzenet
          const verification = await this.authService.verifyActivationCode(code);

          if (!verification.valid) {
            this._showMessage(verification.message || '√ârv√©nytelen aktiv√°ci√≥s k√≥d', 'error');
             if(activateBtn) {
                 activateBtn.disabled = false;
                 activateBtn.textContent = 'Aktiv√°l√°s';
              }
            return;
          }

          // Ha a k√≥d √©rv√©nyes, de az eszk√∂z m√°r aktiv√°lva van
          if (verification.alreadyActivated) {
            this._showMessage('Eszk√∂z sikeresen azonos√≠tva!', 'success');
            // A currentUser biztosan l√©tezik ekkorra
            // Friss√≠ts√ºk a hiteles√≠t√©si adatokat a local storage-ban (redund√°ns lehet, de biztos√≠t)
            await this.authService.storeCredentials(currentUser);

          } else {
            // √öj aktiv√°l√°s (els≈ë eszk√∂z vagy √∫j eszk√∂z hozz√°ad√°sa)
            this._showMessage('Sikeres aktiv√°ci√≥! Eszk√∂z hozz√°ad√°sa...', 'success');
            // A currentUser biztosan l√©tezik ekkorra
            // K√≥d megjel√∂l√©se akt√≠vk√©nt √©s eszk√∂z hozz√°ad√°sa
            await this.authService.markCodeAsActive(code, currentUser.uid);
            // Hiteles√≠t√©s ment√©se
            await this.authService.storeCredentials(currentUser);
          }

          // UI friss√≠t√©se √©s √°tir√°ny√≠t√°s/k√∂nyvmegjelen√≠t√©s
          this.isActivated = true;

          // Jelezz√ºk a sikert az inicializ√°l√≥ k√≥dnak (pl. az index.html-ben)
          // L√©trehozunk egy egyedi esem√©nyt
           const activationSuccessEvent = new Event('activationSuccess');
           document.dispatchEvent(activationSuccessEvent);


          // Kis sz√ºnet a sikeres √ºzenet megjelen√≠t√©s√©hez, majd UI elt√ºntet√©se
          setTimeout(() => {
            this.remove(); // UI elt√°vol√≠t√°sa a remove() f√ºggv√©nnyel
             console.log("Aktiv√°ci√≥s fel√ºlet elt√°vol√≠tva.");
             // Az alkalmaz√°s ind√≠t√°s√°t most m√°r az index.html-ben l√©v≈ë
             // 'activationSuccess' esem√©nyre figyel≈ë k√≥dnak kellene kezelnie.
          }, 1500); // K√©sleltet√©s a sikeres √ºzenet olvashat√≥s√°g√°√©rt

        } catch (error) {
          console.error('Aktiv√°l√°si hiba a _handleActivationben:', error);
          // √Åltal√°nos hiba√ºzenet, ha valami v√°ratlan t√∂rt√©nik
          // (pl. a bejelentkez√©s vagy a Firestore m≈±velet dob kiv√©telt)
          this._showMessage('Hiba t√∂rt√©nt az aktiv√°l√°s sor√°n: ' + error.message, 'error');

          if (activateBtn) {
            activateBtn.disabled = false;
            activateBtn.textContent = 'Aktiv√°l√°s';
          }
        }
      }

      // Aktiv√°ci√≥s UI elt√°vol√≠t√°sa
      remove() {
        if (this.activationContainer) {
          this.activationContainer.remove();
          this.activationContainer = null; // T√∂r√∂lj√ºk a referenci√°t is
          console.log("Aktiv√°ci√≥s kont√©ner elt√°vol√≠tva.");
        }
      }
    }

    // Glob√°lis AuthService √©s ActivationUI l√©trehoz√°sa
    try {
      updateLoadingMessage('auth');
      window.authService = new AuthService();
      window.activationUI = new ActivationUI();
      console.log("AuthService √©s ActivationUI sikeresen l√©trehozva");
    } catch (error) {
      console.error("Hiba az AuthService vagy ActivationUI l√©trehoz√°sakor:", error);
      showErrorScreen("Hiba az authentik√°ci√≥ l√©trehoz√°sakor: " + error.message);
    }
  </script>
  
  <!-- TypeScript-b≈ël ford√≠tott JavaScript -->
  <script src="flipbook-engine.js"></script>
  
  <!-- F≈ë alkalmaz√°s inicializ√°ci√≥ -->
  <script>
    // Esem√©nyfigyel≈ë az aktiv√°ci√≥ siker√©hez - EL≈êRE defini√°ljuk!
    document.addEventListener('activationSuccess', function() {
      console.log("Aktiv√°ci√≥ sikeres esem√©ny elkapva!");
      
      try {
        updateLoadingMessage('book');
        
        // FlipbookEngine inicializ√°l√°sa az aktiv√°ci√≥ ut√°n
        const flipbook = new FlipbookEngine({
          containerId: 'book-container',
          totalPages: 300,
          soundPath: 'sounds/pageturn-102978.mp3'
        });
        
        // Bet√∂lt≈ë k√©perny≈ë elrejt√©se
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
          setTimeout(() => {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }, 300);
        }
        
        // Hang bet√∂lt√©se csak ha val√≥ban sz√ºks√©ges
        document.getElementById('flip-sound').preload = 'auto';
        
        console.log('Flipbook sikeres inicializ√°l√°sa az aktiv√°ci√≥ ut√°n!');
      } catch (err) {
        console.error("Hiba a FlipbookEngine inicializ√°l√°sakor:", err);
        showErrorScreen("Nem siker√ºlt bet√∂lteni a k√∂nyvet. K√©rj√ºk, pr√≥b√°ld √∫jra.");
      }
    });

    // Oldal bet√∂lt≈ëd√©sekor
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log("DOMContentLoaded esem√©ny aktiv√°lva");
        updateLoadingMessage('activation');
        
        // Aktiv√°ci√≥ ellen≈ërz√©se
        if (window.activationUI) {
          const isActivated = await window.activationUI.initialize();
          
          // Ha aktiv√°lva van, folytatjuk a norm√°l inicializ√°l√°st
          if (isActivated) {
            try {
              updateLoadingMessage('book');
              
              // FlipbookEngine inicializ√°l√°sa
              const flipbook = new FlipbookEngine({
                containerId: 'book-container',
                totalPages: 300,
                soundPath: 'sounds/pageturn-102978.mp3'
              });
              
              // Hang bet√∂lt√©se csak ha val√≥ban sz√ºks√©ges
              document.getElementById('flip-sound').preload = 'auto';
              
              // Bet√∂lt≈ë k√©perny≈ë elrejt√©se
              const loadingScreen = document.getElementById('loading-screen');
              if (loadingScreen) {
                setTimeout(() => {
                  loadingScreen.style.opacity = '0';
                  setTimeout(() => {
                    loadingScreen.style.display = 'none';
                  }, 500);
                }, 500);
              }
              
              updateLoadingMessage('complete');
              console.log('Minden sikeresen inicializ√°lva');
            } catch (err) {
              console.error("Hiba a FlipbookEngine inicializ√°l√°sakor:", err);
              showErrorScreen("Nem siker√ºlt bet√∂lteni a k√∂nyvet. K√©rj√ºk, pr√≥b√°ld √∫jra.");
            }
          } else {
            // Ha nincs aktiv√°lva, elrejtj√ºk a bet√∂lt≈ë k√©perny≈ët,
            // hogy l√°tsz√≥djon az aktiv√°ci√≥s ≈±rlap
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
              loadingScreen.style.display = 'none';
            }
          }
        } else {
          console.error("Az activationUI nem √©rhet≈ë el!");
          showErrorScreen("Nem siker√ºlt inicializ√°lni az aktiv√°ci√≥s rendszert.");
        }
      } catch (error) {
        console.error('Hiba az inicializ√°l√°s sor√°n:', error);
        // Bet√∂lt≈ë k√©perny≈ë elrejt√©se hiba eset√©n
        document.getElementById('loading-screen').style.display = 'none';
        showErrorScreen("Hiba t√∂rt√©nt az alkalmaz√°s inicializ√°l√°sakor: " + error.message);
      }
    });
  </script>
  
  <!-- Install prompt handler -->
  <script>
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-banner').style.display = 'block';
    });

    document.getElementById('install-banner')
      .addEventListener('click', async () => {
        const banner = document.getElementById('install-banner');
        banner.style.display = 'none';
        await deferredPrompt.prompt();
        deferredPrompt = null;
      });
  </script>

  <!-- Service Worker regisztr√°l√°s -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('./service-worker.js')
        .then(() => console.log('Service Worker regisztr√°lva'))
        .catch(err => console.error('SW hiba:', err));
    }
  </script>
</body>
</html>